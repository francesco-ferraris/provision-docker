---
- name: Install openssl
  package:
    name: openssl
    state: present

- name: Expose Docker daemon securely
  vars:
    dds_host: "{{ ansible_host }}"
  include_role:
    name: alexinthesky.secure-docker-daemon

- name: Configure docker service
  copy:
    src: docker.service
    dest: /lib/systemd/system/docker.service
    mode: '0644'

- name: Reload daemon configuration
  systemd:
    daemon_reload: true

- name: Ensure /etc/docker/ directory exists
  file:
    path: /etc/docker
    state: directory
    mode: '0755'
  when: docker_daemon_options.keys() | length > 0

- name: Configure Docker daemon options.
  copy:
    content: "{{ docker_daemon_options | to_nice_json }}"
    dest: "/etc/docker/daemon.json"
    mode: '0644'
  when: docker_daemon_options.keys() | length > 0
  notify: restart docker

- include_tasks: "automatic-startup.yml"

#- name: Set default TLS authentication
#  copy:
#    remote_src: true
#    src: "/root/.docker/"
#    dest: "/home/{{ ansible_user }}/.docker/"
#    owner: "{{ ansible_user }}"
#    group: "{{ ansible_user }}"
#    mode: '0744'

#- name: Fetch client certificates
#  fetch:
#    src: "/root/.docker/{{ item }}"
#    dest: "{{ client_cert_dest_folder }}"
#  with_items:
#    - "ca.pem"
#    - "cert.pem"
#    - "key.pem"
